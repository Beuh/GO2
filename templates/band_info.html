{% extends 'go2base.html' %}

{% block content %}
    <div class="row">
        <div class="page-header col-md-8 col-md-offset-2">
            <h2>{{ the_band.name|e }}
            {% if the_band.shortname %}
                ( {{ the_band.shortname }} )
            {% endif %}</h2>
        </div> 
    </div>

    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <strong>Info</strong>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            {% if the_band.description %}
                                {{ the_band.description | html_content | safe  }}
                            {% else %}
                                A Band of Mystery...
                            {% endif %}
                        </div>
                    </div>
                    {% if the_band.website %}
                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                &nbsp;
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-2 col-sm-2 col-xs-3">Website</div>
                            <div class="col-md-10 col-sm-10 col-xs-9">
                                    <a href="http://{{the_band.website}}" target="new">{{ the_band.website|e }}</a>
                            </div>
                        </div>
                    {% endif %}
                    <div class="row">
                        {% if the_user_is_band_admin or the_user_is_superuser %}
                            <br>
                            <div class="col-md-12">
                                <a class="btn btn-primary btn-sm" href="band_edit.html?bk={{ the_band.key.urlsafe() }}">Edit</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div> <!-- panel -->
            {% if the_user_is_associated == False and ( the_user_is_superuser == False ) %}
            {% elif the_user_is_confirmed == False and ( the_user_is_superuser == False ) %}
                Your membership is pending - ask a band member to confirm you!
            {% else %}
                {% if the_pending_members %}
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <strong>
                                Pending Members <span class="badge">{{the_pending_members|length}}</span>
                            </strong>
                        </div>        
                        <div class="panel-body">
                            {% for m in the_pending_members %}
                            <div class="row">
                                <div class="col-md-3 col-sm-3 col-xs-4">
                                    {{ m.name|e }}
                                </div>
                                <div class="col-md-9 col-sm-9 col-xs-8">
                                    <a class="btn btn-default btn-sm" href="/band_confirm_member?do=1&mk={{m.key.urlsafe()}}&bk={{the_band.key.urlsafe()}}">yes, confirm member!</a>
                                    <a class="btn btn-default btn-sm" href="/band_removemember?mk={{m.key.urlsafe()}}&bk={{the_band.key.urlsafe()}}">no, reject!</a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div> <!-- panel -->        
                {% endif %}

                <div class="row">
                    <div class="col-md-12 col-md-offset-0">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="row">
                            {% if num_sections == 0 %}
                                <div class="col-md-10 col-sm-10 col-xs-10">
                                    <strong>Members</strong>
                                </div>
                            {% else %}
                                <div class="col-md-2 col-sm-2 col-xs-3">
                                    <strong>Sections</strong>
                                </div>
                                <div class="col-md-8 col-sm-8 col-xs-7">
                                    Members
                                </div>
                            {% endif %}
                            {% if num_sections > 1 and (the_user_is_superuser or the_user_is_band_admin) %}
                                <div class="col-md-2 col-sm-2 col-xs-2">
                                    Order
                                </div>
                            {% endif %}
                        </div>
                    </div>        
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-12 col-md-offset-0" id="sectionlist">
                        <i class="fa fa-spinner fa-spin fa-lg"></i>
                            </div>
                        </div>
                        <div class="row">
                            {% if the_user_is_superuser or the_user_is_band_admin %}
                                <div class="col-md-4 col-md-offset-0">
                                    <br>
                                    <a data-toggle="modal" href="#newsectionmodal" class="btn btn-primary btn-sm" id="{{the_band.key.urlsafe()}}">Add a Section</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div> <!-- panel -->
                        
                    </div>
                </div>

                {% if the_user_is_band_admin or the_user_is_superuser %}   
                <div class="panel-group" id="accordion"> 
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                                <strong>
                                    Member Admin
                                </strong>
                            </a>
                        </div>
                        <div id="collapseOne" class="panel-collapse collapse">
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-12 col-md-offset-0" id="memberlist">
                                        <i class="fa fa-spinner fa-spin fa-lg"></i>
                                    </div>
                                </div>
                            </div>
                        <//div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}
{% endblock content %}

{% block modal %}
    {% if the_user_is_superuser or the_user_is_band_admin %}
	<!-- Modal -->
    <div class="modal fade" id="newsectionmodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="modal-form" accept-charset="UTF-8" data-remote="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Add a Section</h4>
                    </div>
                    <div class="modal-body">
                            <div class="form-group">
                                <label for="newsectioninput" class="control-label">New Section</label>
                                <input type="text form-control" id="newsectioninput" placeholder="Section Name" name="new_section">
                            </div>
                        </form>                    
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <input type="submit" class="btn btn-primary" id="savenewsection" value="Save">
                    </div>
                </div><!-- /.modal-content -->
            </form>
        </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	{% endif %}					
{% endblock modal %}

{% block localscripts %}
<script src="/js/jquery.validate.js"></script>
<script>
function updateMembers() {
    $.post('/band_get_members',
            {
                bk: '{{ the_band.key.urlsafe() }}'
            },
            function(responseTxt,statusTxt,xhr){
                if(statusTxt=="success")
                    document.getElementById('memberlist').innerHTML=responseTxt;
                if(statusTxt=="error")
                    alert("Error: "+xhr.status+": "+xhr.statusText);
            });
}

function updateSections() {
    $.post('/band_get_sections',
            {
                bk: '{{ the_band.key.urlsafe() }}'
            },
            function(responseTxt,statusTxt,xhr){
                if(statusTxt=="success")
                    document.getElementById('sectionlist').innerHTML=responseTxt;
                if(statusTxt=="error")
                    alert("Error: "+xhr.status+": "+xhr.statusText);
            });
}

function handle_new_section() {
    $('#newsectionmodal').modal('hide');
    name=document.getElementById('newsectioninput').value;
    $('#newsectioninput').val(''); // reset the placeholder
    $.post("/band_new_section",
            {
                bk: "{{the_band.key.urlsafe()}}",
                section_name: name
            },
            function(responseTxt,statusTxt,xhr){
                if(statusTxt=="success")
                    updateSections();
                if(statusTxt=="error")
                  alert("Error: "+xhr.status+": "+xhr.statusText);
            });

    return false;
}

function move(dir,sk) {
    $.post("/band_move_section",
            {
                dir: dir,
                sk: sk
            },
            function(responseTxt,statusTxt,xhr){
                if(statusTxt=="success")
                    updateSections();
                if(statusTxt=="error")
                  alert("Error: "+xhr.status+": "+xhr.statusText);
            });

    return false;
}

function delete_section(sk) {
    $.post("/band_delete_section",
            {
                sk: sk
            },
            function(responseTxt,statusTxt,xhr){
                if(statusTxt=="success")
                    updateSections();
                if(statusTxt=="error")
                  alert("Error: "+xhr.status+": "+xhr.statusText);
            });

    return false;
}

function member_section(mk, sk) {
    var bk='{{the_band.key.urlsafe()}}';
    $.post('/member_set_section',
            {
                mk: mk,
                sk: sk,
                bk: bk
            },
            function(responseTxt,statusTxt,xhr){
                if(statusTxt=="success")
                    setTimeout(function(){updateSections(); updateMembers();}, 1000);
                if(statusTxt=="error")
                    alert("Error: "+xhr.status+": "+xhr.statusText);
            });
}

$(document).ready(function() {
    updateMembers();
    updateSections();

    $("#modal-form").validate({
        rules: {
            new_section: {
                required: true
            }
        },
        submitHandler: handle_new_section
    });
});
</script>
{% endblock localscripts %}